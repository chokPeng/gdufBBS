package com.robben.bbs.config;import com.robben.bbs.pojo.OrdinaryUser;import com.robben.bbs.service.OrdinaryUserService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;import org.springframework.security.config.annotation.web.builders.HttpSecurity;import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;import org.springframework.security.core.GrantedAuthority;import org.springframework.security.core.authority.SimpleGrantedAuthority;import org.springframework.security.core.userdetails.User;import org.springframework.security.core.userdetails.UserDetails;import org.springframework.security.core.userdetails.UserDetailsService;import org.springframework.security.core.userdetails.UsernameNotFoundException;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;import org.springframework.security.crypto.password.PasswordEncoder;import org.springframework.stereotype.Component;import java.util.HashSet;import java.util.Set;@Configuration@EnableWebSecurity@EnableGlobalMethodSecurity(prePostEnabled = true)public class SecurityConfiguration extends WebSecurityConfigurerAdapter {    @Bean    public PasswordEncoder passwordEncoder() {        return new BCryptPasswordEncoder();    }    @Autowired    private MyCustomUserDetailsService myCustomUserDetailsService;    @Autowired    PasswordEncoder passwordEncoder;    @Autowired    OrdinaryUserService ordinaryUserService;    @Override    protected void configure(HttpSecurity httpSecurity) throws Exception {        //任何请求都要经过认证        //httpSecurity.authorizeRequests().anyRequest().authenticated().and()        // .formLogin().and().authorizeRequests();        httpSecurity.authorizeRequests().antMatchers("test").permitAll()                .antMatchers("hello").authenticated().and().                formLogin().and()                .logout().deleteCookies("session").and().csrf().disable();        httpSecurity.sessionManagement().maximumSessions(1);    }    @Override    protected void configure(AuthenticationManagerBuilder authenticationManagerBuilder) throws Exception {        authenticationManagerBuilder.userDetailsService(this.myCustomUserDetailsService).passwordEncoder(this.passwordEncoder());    }    @Component    class MyCustomUserDetailsService implements UserDetailsService {        @Override        public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {            //query user by username            OrdinaryUser user =                    ordinaryUserService.queryByUsername(username);            Set<GrantedAuthority> authorities=new HashSet<>();            SimpleGrantedAuthority grantedAuthority=                    new SimpleGrantedAuthority(user.getRole());            authorities.add(grantedAuthority);            return new User(username,user.getPassword(),authorities);        }    }}